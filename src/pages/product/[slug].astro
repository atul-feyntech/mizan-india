---
import BaseLayout from '../../layouts/BaseLayout.astro';
import MizanScore from '../../components/product/MizanScore.astro';
import SafeLimit from '../../components/product/SafeLimit.astro';
import NutritionBar from '../../components/product/NutritionBar.astro';
import IngredientAnalysis from '../../components/product/IngredientAnalysis.astro';
import TheRoast from '../../components/product/TheRoast.astro';
import Alternatives from '../../components/product/Alternatives.astro';
import ShareButtons from '../../components/ui/ShareButtons.astro';
import productsData from '../../data/products.json';
import type { Product, NutrientStatus } from '../../types';

export async function getStaticPaths() {
  const products = productsData.products as Product[];
  return products.map((product) => ({
    params: { slug: product.slug },
    props: { product },
  }));
}

interface Props {
  product: Product;
}

const { product } = Astro.props;

// Helper to get nutrition status
function getNutritionStatus(value: number, thresholds: { ok: number; moderate: number; high: number }): NutrientStatus {
  if (value <= thresholds.ok) return 'ok';
  if (value <= thresholds.moderate) return 'moderate';
  if (value <= thresholds.high) return 'high';
  return 'critical';
}

const nutrients = product.nutrients;

// Normalize nutrient field names (handle both old and new formats)
const sugarG = nutrients.sugar_g ?? nutrients.sugars_g ?? 0;
const fatG = nutrients.total_fat_g ?? nutrients.fat_g ?? 0;

// Calculate daily percentages for nutrition bars
const sodiumDailyPct = Math.round((nutrients.sodium_mg / 2000) * 100);
const sugarDailyPct = Math.round((sugarG / 50) * 100);
const satFatDailyPct = Math.round((nutrients.saturated_fat_g / 22) * 100);
const calorieDailyPct = Math.round((nutrients.energy_kcal / 2000) * 100);

// Handle optional fields
const alternatives = product.alternatives ?? [];
const roast = product.roast ?? null;
const ingredientsAnalysis = product.ingredients_analysis ?? { ingredients: product.ingredients ?? [], additives: [], flags: product.flags ?? [] };
const novaGroup = product.nova_group ?? 4;
const brandSlug = product.brand_slug ?? product.brand?.toLowerCase().replace(/\s+/g, '-') ?? '';
const dataSource = product.source ?? product.data_source ?? 'Open Food Facts';
const lastUpdated = product.last_updated ?? new Date().toISOString().split('T')[0];
const scoreSummary = product.mizan_score?.summary ?? `${product.mizan_score?.stars ?? 0} star rating based on FSSAI guidelines`;
---

<BaseLayout
  title={`${product.name} - Mizan Score ${product.mizan_score.stars}/5`}
  description={`${product.name} by ${product.brand}: ${scoreSummary}. Safe limit: ${product.safe_limit.recommended_serving_g}g. Honest health rating and verdict.`}
>
  <article class="py-8 md:py-12">
    <div class="container mx-auto px-4 max-w-4xl">

      <!-- Breadcrumb -->
      <nav class="text-sm text-gray-500 mb-6">
        <a href="/" class="hover:text-mizan-teal">Home</a>
        <span class="mx-2">â€º</span>
        <a href={`/category/${product.category_slug}`} class="hover:text-mizan-teal">{product.category}</a>
        <span class="mx-2">â€º</span>
        <span class="text-gray-700">{product.name}</span>
      </nav>

      <!-- Product Header -->
      <header class="mb-8">
        <div class="flex items-start gap-4">
          <div>
            <h1 class="font-heading text-2xl md:text-3xl font-bold text-gray-900 mb-2">
              {product.name}
            </h1>
            <p class="text-gray-600">
              <span class="hover:text-mizan-teal">{product.brand}</span>
              <span class="mx-2">â€¢</span>
              <a href={`/category/${product.category_slug}`} class="hover:text-mizan-teal">{product.category}</a>
              <span class="mx-2">â€¢</span>
              {product.package_size_g}g
              {product.price_inr && (
                <>
                  <span class="mx-2">â€¢</span>
                  <span>â‚¹{product.price_inr}</span>
                </>
              )}
                </>
              )}
            </p>
          </div>
        </div>
      </header>

      <!-- Mizan Score -->
      <section class="mb-8">
        <MizanScore score={product.mizan_score} size="lg" />
      </section>

      <!-- Safe Limit -->
      <section class="mb-8">
        <SafeLimit safeLimit={product.safe_limit} packageSize={product.package_size_g} />
      </section>

      <!-- Nutrition Breakdown -->
      <section class="mb-8 bg-white rounded-xl card-shadow p-5">
        <div class="flex items-center gap-2 mb-6">
          <span class="text-2xl">ðŸ“Š</span>
          <h2 class="font-heading text-xl text-mizan-teal font-bold">
            NUTRITION BREAKDOWN
          </h2>
          <span class="text-sm text-gray-400">(per 100g)</span>
        </div>

        <div class="space-y-1">
          <NutritionBar
            label="Calories"
            value={nutrients.energy_kcal}
            unit="kcal"
            dailyPercent={calorieDailyPct}
            maxValue={500}
            status={getNutritionStatus(nutrients.energy_kcal, { ok: 200, moderate: 350, high: 450 })}
          />
          <NutritionBar
            label="Sodium"
            value={nutrients.sodium_mg}
            unit="mg"
            dailyPercent={sodiumDailyPct}
            maxValue={1500}
            status={getNutritionStatus(nutrients.sodium_mg, { ok: 400, moderate: 800, high: 1200 })}
          />
          <NutritionBar
            label="Sugar"
            value={sugarG}
            unit="g"
            dailyPercent={sugarDailyPct}
            maxValue={50}
            status={getNutritionStatus(sugarG, { ok: 5, moderate: 15, high: 25 })}
          />
          <NutritionBar
            label="Sat. Fat"
            value={nutrients.saturated_fat_g}
            unit="g"
            dailyPercent={satFatDailyPct}
            maxValue={22}
            status={getNutritionStatus(nutrients.saturated_fat_g, { ok: 3, moderate: 8, high: 15 })}
          />
          <NutritionBar
            label="Protein"
            value={nutrients.protein_g}
            unit="g"
            maxValue={20}
            status={nutrients.protein_g >= 10 ? 'ok' : nutrients.protein_g >= 5 ? 'moderate' : 'high'}
          />
          <NutritionBar
            label="Fiber"
            value={nutrients.fiber_g}
            unit="g"
            maxValue={10}
            status={nutrients.fiber_g >= 5 ? 'ok' : nutrients.fiber_g >= 2 ? 'moderate' : 'high'}
          />
          <NutritionBar
            label="Carbs"
            value={nutrients.carbohydrates_g}
            unit="g"
            maxValue={80}
            status="moderate"
          />
          <NutritionBar
            label="Fat"
            value={fatG}
            unit="g"
            maxValue={40}
            status={getNutritionStatus(fatG, { ok: 10, moderate: 20, high: 30 })}
          />
        </div>
      </section>

      <!-- Ingredient Analysis -->
      <section class="mb-8">
        <IngredientAnalysis analysis={ingredientsAnalysis} novaGroup={novaGroup} />
      </section>

      <!-- The Roast -->
      {roast && (
        <section class="mb-8">
          <TheRoast roast={roast} />
        </section>
      )}

      <!-- Alternatives -->
      {alternatives.length > 0 && (
        <section class="mb-8">
          <Alternatives alternatives={alternatives} />
        </section>
      )}

      <!-- Share & Sources -->
      <footer class="pt-8 border-t border-gray-200">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
          <ShareButtons
            url={Astro.url.href}
            title={`${product.name} - Mizan Score: ${product.mizan_score.stars}/5`}
            text={roast?.verdict_en ?? `${product.name} has a ${product.mizan_score.stars}-star Mizan rating`}
          />

          <div class="text-sm text-gray-500">
            <p>
              Data: {dataSource}
              <span class="mx-2">â€¢</span>
              Updated: {lastUpdated}
            </p>
            <p class="mt-1">
              <a href="/hum/tareeka" class="text-mizan-teal hover:underline">Methodology</a>
              <span class="mx-2">â€¢</span>
              <a href="#" class="text-mizan-teal hover:underline">Report Error</a>
            </p>
          </div>
        </div>
      </footer>

    </div>
  </article>
</BaseLayout>
